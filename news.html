<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>News | Angers Lab</title>
  <meta name="description" content="Latest news featuring Stephane Angers and Angers Lab biomedical research." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230a0a0a'/><text x='50' y='58' font-size='60' text-anchor='middle' fill='%23ffffff' font-family='Arial, Helvetica, sans-serif'>A</text></svg>">
  <style>
    :root { --bg:#0b0c10; --panel:#111317; --elev:#161a20; --text:#e9eef5; --muted:#aeb6c2; --brand:#59d5ff; --brand-2:#7bffb1; --link:var(--brand); --maxw:1100px; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35) }
    @media (prefers-color-scheme: light){ :root{ --bg:#f6f8fb; --panel:#ffffff; --elev:#f1f4f8; --text:#0f172a; --muted:#4b5563; --brand:#005bff; --brand-2:#00ad6b; --link:#0b63ff } }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);
         background:radial-gradient(1200px 600px at 80% -50%, rgba(89,213,255,.15), transparent 60%), radial-gradient(900px 500px at -10% 0%, rgba(123,255,177,.12), transparent 55%), var(--bg);
         line-height:1.55}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:var(--maxw);margin-inline:auto;padding-inline:clamp(16px,3vw,32px)}
    h1{font-size:clamp(28px,4vw,44px);margin:10px 0 8px}
    .lead{color:var(--muted);max-width:72ch}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    .mt-1{margin-top:6px}.mt-2{margin-top:12px}.mt-3{margin-top:18px}.mt-4{margin-top:26px}
    /* Canonical site header + nav */
    header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(140%) blur(8px); background: linear-gradient(180deg, color-mix(in oklab, var(--bg) 30%, transparent), color-mix(in oklab, var(--bg) 55%, transparent)), url('assets/images/banner-wnt.svg') center/cover no-repeat; border-bottom: 2px solid color-mix(in oklab, var(--text) 10%, transparent); }
    .nav { display: flex; align-items: center; justify-content: space-between; height: 80px; }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; letter-spacing: .2px; }
    .brand .logo { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), var(--brand-2)); display: grid; place-items: center; color: #001319; font-weight: 900; box-shadow: var(--shadow); }
    nav ul { list-style: none; margin: 0; padding: 0; display: flex; gap: 22px; align-items: center; }
    nav a { color: var(--text); opacity: .95; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,.25); }
    nav a.active { font-weight: bold; text-decoration: underline; }
    .menu-btn { display: none; background: none; border: none; color: var(--text); font-size: 28px; }
    @media (max-width: 860px) {
      nav ul { display: none; position: absolute; top: 64px; left: 0; right: 0; background: var(--panel); border-bottom: 2px solid color-mix(in oklab, var(--text) 10%, transparent); padding: 12px 18px; flex-direction: column; gap: 8px; }
      .menu-btn { display: inline-block !important; }
      nav ul.open { display: flex !important; }
      body.no-scroll { overflow: hidden; }
    }
    /* News list */
    main{padding:clamp(24px,5vw,48px) 0}
    .news-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:clamp(12px,2vw,20px)}
    .news-card{grid-column:span 12;background:var(--panel);border:1px solid color-mix(in oklab, var(--text) 10%, transparent);border-radius:18px;padding:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:clamp(12px,2vw,18px);min-width:0}
    .news-main{display:flex;flex-direction:column;gap:10px;min-width:0}
    .news-header{display:flex;align-items:flex-start;gap:clamp(12px,2vw,18px)}
    .news-title{margin:0;font-size:18px;line-height:1.35;flex:1;min-width:0}
    .news-thumb{width:clamp(150px,28vw,220px);aspect-ratio:16/9;display:grid;place-items:center;border-radius:14px;overflow:hidden;background:color-mix(in oklab, var(--text) 6%, transparent);box-shadow:inset 0 0 0 1px color-mix(in oklab, var(--text) 8%, transparent);color:var(--muted);text-align:center;font-size:.85rem;padding:8px;position:relative;text-decoration:none;font-weight:600;flex-shrink:0}
    .news-thumb:hover{text-decoration:none}
    .news-thumb img{grid-area:1/1;width:100%;height:100%;object-fit:cover}
    .news-thumb__fallback{grid-area:1/1;padding:0 6px}
    .news-thumb.has-image{color:transparent;background:color-mix(in oklab, var(--text) 4%, transparent)}
    .news-thumb.has-image .news-thumb__fallback{display:none}
    .news-thumb.is-empty{color:var(--muted)}
    .news-actions{justify-content:flex-start}
    @media (max-width:720px){
      .news-header{flex-direction:column;align-items:stretch}
      .news-thumb{width:100%}
    }
    .news-meta{color:var(--muted);font-size:.95rem}
    .news-actions{display:flex;gap:10px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:color-mix(in oklab, var(--text) 8%, transparent);color:var(--text);font-weight:600}
    .empty{color:var(--muted);padding:14px 0}
    footer{border-top:1px solid color-mix(in oklab, var(--text) 10%, transparent);padding:18px 0 32px;color:var(--muted)}
    .footer-grid{display:grid;grid-template-columns:2fr 1fr 1fr;gap:24px}
    .footer-grid a{color:var(--muted)}
    @media (max-width:820px){ .footer-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <a class="sr-only" href="#main">Skip to content</a>
  <header>\n    <div class="wrap nav">
      <a aria-label="Angers Lab Home" class="brand" href="index.html">
        <span class="logo">A</span>
        <span>Angers Lab<br/><small>Cellular Signaling &amp; Regeneration</small></span>
      </a>
      <nav>
        <button class="menu-btn" aria-label="Open menu" onclick="toggleMenu()" aria-expanded="false">☰</button>
        <ul id="menu">
          <li><a href="index.html">Home</a></li>
          <li><a href="stephane-angers.html">Stephane Angers</a></li>
          <li><a href="research.html">Research</a></li>
          <li><a href="people.html">People</a></li>
          <li><a href="publications.html">Publications</a></li>
          <li><a href="news.html" class="active"><span class="active"></span>News</a></li>
          <li><a href="#contact">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main id="main">
    <section class="wrap page-head">
      <span class="chip">Live from the web</span>
      <h1>News</h1>
      <p class="lead">Automatically curated mentions of <b>Stephane Angers</b> in biomedical science contexts. Each item shows the source and date.</p>
    </section>

    <section class="wrap" id="news-section">
      <div id="status" class="news-meta"></div>
      <div id="news" class="news-grid" aria-live="polite"></div>
    </section>
  </main>

  <footer>
    <div class="wrap footer-grid">
      <div>
        <b>Angers Lab</b>
        <p class="mt-1">Cellular Signaling &amp; Regeneration · Donnelly Centre · University of Toronto</p>
      </div>
      <div>
        <b>Navigate</b>
        <nav class="mt-1">
          <a href="stephane-angers.html">Stephane Angers</a><br>
          <a href="research.html">Research</a><br>
          <a href="people.html">People</a><br>
          <a href="publications.html">Publications</a><br>
          <a href="news.html" class="active"><span class="active"></span>News</a>
        </nav>
      </div>
      <div>
        <b>Social</b>
        <p class="mt-1"><a href="#" aria-label="LinkedIn">LinkedIn</a> · <a href="#" aria-label="Google Scholar">Google Scholar</a> · <a href="#" aria-label="ORCID">ORCID</a></p>
        <p class="mt-1">© <span id="year"></span> Angers Lab. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // Header menu toggle (matches other pages)
    (function () {
      const btn  = document.querySelector('.menu-btn');
      const menu = document.getElementById('menu');
      if (!btn || !menu) return;
      function set(open) {
        menu.classList.toggle('open', open);
        btn.setAttribute('aria-expanded', String(open));
        document.body.classList.toggle('no-scroll', open);
      }
      window.toggleMenu = () => set(!menu.classList.contains('open'));
      menu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => set(false)));
      window.addEventListener('resize', () => { if (window.innerWidth > 860) set(false); });
    })();
    document.getElementById('year').textContent = new Date().getFullYear();

    // --- News aggregation ---
    (async function loadNews(){
      const statusEl = document.getElementById('status');
      const listEl = document.getElementById('news');

      const KEYWORDS = [
        'wnt','frizzled','β-catenin','beta-catenin','cancer','regeneration','glioblastoma','signaling','donnelly','university of toronto','fgf','surrogate','agonist','endothelial','barrier'
      ];

      const PREVIEW_CACHE = new Map();
      const PREVIEW_META_SELECTORS = [
        'meta[property="og:image:secure_url"]',
        'meta[property="og:image:url"]',
        'meta[property="og:image"]',
        'meta[name="og:image"]',
        'meta[property="twitter:image:src"]',
        'meta[name="twitter:image:src"]',
        'meta[property="twitter:image"]',
        'meta[name="twitter:image"]',
        'meta[property="article:image"]',
        'meta[name="image"]',
        'meta[name="thumbnail"]',
        'meta[property="thumbnail"]',
        'link[rel="image_src"]'
      ];
      const AGGREGATOR_HOST_PATTERNS = [
        /(^|\.)news\.google\./i,
        /(^|\.)news\.yahoo\./i,
        /(^|\.)newssearch\.yahoo\./i,
        /(^|\.)news\.search\.yahoo\./i,
        /(^|\.)google\.com$/i
      ];

      function isLikelyImageUrl(url){
        const trimmed = (url || '').trim();
        if(!trimmed || /^data:/i.test(trimmed)) return false;
        const normalized = trimmed.replace(/^https?:\/\//i, '').replace(/^\/\//, '').trim();
        const bare = trimmed.split('?')[0].split('#')[0];
        if(/\.(jpe?g|png|gif|bmp|webp|avif|heic|heif|svg)$/i.test(bare)) return true;
        const query = trimmed.split('?')[1] || '';
        if(/(format|width|height|quality|image|photo|media|thumb|webp|jpeg|jpg|png|img|size|crop|fit|url=|w=|h=)/i.test(query)) return true;
        return /(image|photo|media|thumbnail|uploads|wp-content|cdn|static|assets|img)/i.test(normalized);
      }

      function chooseFromSrcset(value){
        if(!value || typeof value !== 'string') return '';
        const entries = value.split(',').map(part => {
          const trimmed = part.trim();
          if(!trimmed) return null;
          const tokens = trimmed.split(/\s+/).filter(Boolean);
          if(!tokens.length) return null;
          const urlPart = tokens.shift();
          let width = 0; let density = 0;
          tokens.forEach(token => {
            if(token.endsWith('w')){
              const parsed = parseInt(token, 10);
              if(isFinite(parsed)) width = parsed;
            } else if(token.endsWith('x')){
              const parsed = parseFloat(token);
              if(isFinite(parsed)) density = parsed;
            }
          });
          return { url: (urlPart || '').trim(), width, density };
        }).filter(entry => entry && entry.url && !/^data:/i.test(entry.url));
        if(!entries.length) return '';
        entries.sort((a, b) => {
          if(a.width !== b.width) return b.width - a.width;
          return b.density - a.density;
        });
        return entries[0]?.url || '';
      }

      function bestFromImageElement(el){
        if(!el) return '';
        const prioritizedAttrs = [
          'data-original', 'data-src', 'data-srcset', 'data-large-image', 'data-lazy-src', 'data-highres', 'data-hires',
          'data-img', 'data-image', 'data-photo', 'data-fullsrc', 'data-full-src', 'srcset', 'src'
        ];
        for(const attr of prioritizedAttrs){
          const val = el.getAttribute(attr);
          if(!val) continue;
          if(attr.includes('srcset')){
            const chosen = chooseFromSrcset(val);
            if(chosen) return chosen;
          } else {
            const trimmed = val.trim();
            if(trimmed && !/^data:/i.test(trimmed) && (attr === 'src' || isLikelyImageUrl(trimmed))) return trimmed;
          }
        }
        if(el.dataset){
          for(const key of Object.keys(el.dataset)){
            if(/(src|image|photo|img)$/i.test(key)){
              const val = el.dataset[key];
              if(val && val.trim() && !/^data:/i.test(val)){
                const trimmed = val.trim();
                if(isLikelyImageUrl(trimmed) || /(^https?:|^\/\/)/i.test(trimmed) || trimmed.startsWith('/')) return trimmed;
              }
            }
          }
        }
        return '';
      }

      function bestFromPicture(el){
        if(!el) return '';
        const sources = el.querySelectorAll('source[srcset], source[data-srcset]');
        for(const source of sources){
          const val = source.getAttribute('srcset') || source.getAttribute('data-srcset');
          const chosen = chooseFromSrcset(val);
          if(chosen) return chosen;
        }
        const img = el.querySelector('img');
        if(img){
          const fromImg = bestFromImageElement(img);
          if(fromImg) return fromImg;
        }
        return '';
      }

      function gatherJsonLdImages(value, out){
        if(!value) return;
        if(typeof value === 'string'){
          const trimmed = value.trim();
          if(trimmed && !/^data:/i.test(trimmed) && isLikelyImageUrl(trimmed)) out.push(trimmed);
          return;
        }
        if(Array.isArray(value)){
          value.forEach(v => gatherJsonLdImages(v, out));
          return;
        }
        if(typeof value === 'object'){
          const keys = Object.keys(value);
          for(const key of ['url','contentUrl','image','imageUrl','thumbnail','thumbnailUrl','logo','@id']){
            if(key in value) gatherJsonLdImages(value[key], out);
          }
          for(const key of keys){
            if(/image|thumbnail|logo/i.test(key)) gatherJsonLdImages(value[key], out);
          }
        }
      }

      function parseJsonLd(text){
        if(!text) return [];
        const trimmed = text.trim();
        if(!trimmed) return [];
        const attempts = [trimmed];
        if(trimmed.startsWith('{') && /}\s*\n\s*{/.test(trimmed)){
          attempts.push('[' + trimmed.replace(/}\s*\n\s*(?={)/g, '},{') + ']');
        }
        for(const attempt of attempts){
          try{ return Array.isArray(JSON.parse(attempt)) ? JSON.parse(attempt) : [JSON.parse(attempt)]; }
          catch{ /* ignore */ }
        }
        return [];
      }

      function findJsonLdImage(doc){
        const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
        for(const script of scripts){
          const candidates = [];
          const parsed = parseJsonLd(script.textContent || '');
          parsed.forEach(node => gatherJsonLdImages(node, candidates));
          const first = candidates.find(val => !!val && !/^data:/i.test(val) && isLikelyImageUrl(val));
          if(first) return first;
        }
        return '';
      }

      function findDocumentImage(doc){
        if(!doc) return '';
        const selectors = [
          'article picture', 'main picture', 'figure picture', 'picture',
          'article img', 'main img', 'figure img', 'amp-img', 'img'
        ];
        for(const selector of selectors){
          const node = doc.querySelector(selector);
          if(!node) continue;
          const picture = node.tagName && node.tagName.toLowerCase() === 'picture'
            ? node
            : (typeof node.closest === 'function' ? node.closest('picture') : null);
          if(picture){
            const fromPicture = bestFromPicture(picture);
            if(fromPicture) return fromPicture;
          }
          if(node.tagName && node.tagName.toLowerCase() === 'amp-img'){
            const amp = node.getAttribute('src') || node.getAttribute('data-src');
            if(amp && amp.trim() && !/^data:/i.test(amp) && (isLikelyImageUrl(amp) || /(^https?:|^\/\/)/i.test(amp) || amp.trim().startsWith('/'))){
              return amp.trim();
            }
          }
          const fromImg = bestFromImageElement(node);
          if(fromImg) return fromImg;
        }
        const preload = doc.querySelector('link[rel="preload"][as="image"], link[rel="prefetch"][as="image"]');
        if(preload){
          const href = preload.getAttribute('href');
          if(href && href.trim() && !/^data:/i.test(href) && isLikelyImageUrl(href)) return href.trim();
        }
        return '';
      }

      function toProxyURL(url){
        if(!url) return '';
        try {
          const normalized = new URL(url, document.baseURI);
          if(normalized.protocol !== 'http:' && normalized.protocol !== 'https:'){
            return '';
          }
          const target = normalized.protocol + '//' + normalized.host + normalized.pathname + normalized.search + normalized.hash;
          return 'https://r.jina.ai/' + target;
        } catch { return ''; }
      }

      function proxyFetch(url, init){
        const proxied = toProxyURL(url);
        if(!proxied) return Promise.reject(new Error('Invalid URL'));
        const opts = Object.assign({ cache:'no-cache' }, init || {});
        return fetch(proxied, opts);
      }

      function hostFrom(url){
        try { return new URL(url).host.replace(/^www\./,''); } catch { return ''; }
      }

      function isAggregatorUrl(url){
        try {
          const host = new URL(url).host;
          return AGGREGATOR_HOST_PATTERNS.some(re => re.test(host));
        } catch { return false; }
      }

      function safeDecodeURIComponent(str){
        if(typeof str !== 'string') return '';
        try { return decodeURIComponent(str); }
        catch { return ''; }
      }

      function decodeBase64Variant(value){
        if(typeof value !== 'string' || typeof atob !== 'function') return '';
        const sanitized = value.replace(/\s+/g, '').replace(/-/g, '+').replace(/_/g, '/');
        if(!/^[A-Za-z0-9+/=]+$/.test(sanitized)) return '';
        try {
          let padded = sanitized;
          while(padded.length % 4) padded += '=';
          return atob(padded);
        } catch { return ''; }
      }

      function extractUrlFromText(text, base){
        if(typeof text !== 'string' || !text) return '';
        const matches = text.match(/https?:\/\/[^\s"'<>]+/g);
        if(!matches) return '';
        for(const match of matches){
          const candidate = resolveUrlMaybe(match, base);
          if(candidate && !isAggregatorUrl(candidate) && !isLikelyImageUrl(candidate)) return candidate;
        }
        return '';
      }

      function decodeAggregatorLink(value, original){
        if(!value) return '';
        const attempts = new Set();
        const queue = [];
        const push = str => {
          if(typeof str !== 'string' || !str.trim() || attempts.has(str)) return;
          attempts.add(str);
          queue.push(str);
        };
        push(value);
        const resolved = resolveUrlMaybe(value, original);
        if(resolved) push(resolved);
        if(isAggregatorUrl(original)) push(original);

        // decode nested URI components aggressively (handles repeated encoding)
        for(const originalAttempt of Array.from(attempts)){
          let current = originalAttempt;
          let decoded = safeDecodeURIComponent(current);
          let depth = 0;
          while(decoded && decoded !== current && depth < 4){
            push(decoded);
            current = decoded;
            decoded = safeDecodeURIComponent(current);
            depth += 1;
          }
        }

        for(const str of queue){
          const extracted = extractUrlFromText(str, original);
          if(extracted) return extracted;
        }

        const more = new Set(queue);
        queue.forEach(str => {
          if(typeof str !== 'string') return;
          const parts = str.split(/[/?&]/);
          for(const part of parts){
            if(part.length < 8) continue;
            more.add(part);
            const decoded = safeDecodeURIComponent(part);
            if(decoded && decoded !== part) more.add(decoded);
          }
        });

        for(const fragment of more){
          if(typeof fragment !== 'string' || fragment.length < 8) continue;
          const decoded = decodeBase64Variant(fragment);
          if(decoded){
            const extracted = extractUrlFromText(decoded, original);
            if(extracted) return extracted;
          }
        }
        return '';
      }

      function fmtDate(dstr){
        const d = new Date(dstr || '');
        if(!(d instanceof Date) || isNaN(d.getTime())) return dstr || '';
        return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'});
      }

      function includesBioKeywords(text){
        const t = (text||'').toLowerCase();
        return KEYWORDS.some(k => t.includes(k));
      }

      function resolveUrlMaybe(value, base){
        if(!value) return '';
        try { return new URL(value, base || undefined).href; }
        catch { return ''; }
      }

      function normalizeLinkKey(link){
        if(!link) return '';
        try {
          const url = new URL(link, document.baseURI);
          url.hash = '';
          return url.href;
        } catch {
          return String(link || '').trim();
        }
      }

      function mergeItemsWithFeed(localItems, feedItems){
        if(!Array.isArray(localItems) || !localItems.length) return Array.isArray(localItems) ? localItems : [];
        if(!Array.isArray(feedItems) || !feedItems.length) return localItems;
        const lookup = new Map();
        const remember = (key, value) => {
          if(key && !lookup.has(key)) lookup.set(key, value);
        };
        feedItems.forEach(item => {
          if(!item || typeof item !== 'object') return;
          remember(normalizeLinkKey(item.link), item);
          const titleKey = (item.title || '').trim().toLowerCase();
          if(titleKey) remember('title:' + titleKey, item);
        });
        return localItems.map(item => {
          if(!item || typeof item !== 'object') return item;
          const linkKey = normalizeLinkKey(item.link);
          const titleKey = (item.title || '').trim().toLowerCase();
          const match = lookup.get(linkKey) || (titleKey ? lookup.get('title:' + titleKey) : null);
          if(!match) return item;
          return Object.assign({}, match, item);
        });
      }

      function preferExternalArticleUrl(value, original){
        const resolved = resolveUrlMaybe(value, original);
        if(resolved && resolved !== original && !isAggregatorUrl(resolved) && !isLikelyImageUrl(resolved)) return resolved;

        let parsed = null;
        if(resolved){
          try { parsed = new URL(resolved); } catch { parsed = null; }
        }
        if(parsed){
          const nestedParam = parsed.searchParams.get('url') || parsed.searchParams.get('u') || parsed.searchParams.get('target') || parsed.searchParams.get('dest');
          if(nestedParam){
            const nested = resolveUrlMaybe(nestedParam, original);
            if(nested && !isAggregatorUrl(nested) && !isLikelyImageUrl(nested)) return nested;
          }
        }

        if(isAggregatorUrl(original) || (resolved && isAggregatorUrl(resolved))){
          const aggregatorCandidate = decodeAggregatorLink(resolved || value || original, original);
          if(aggregatorCandidate) return aggregatorCandidate;
          const fallback = decodeAggregatorLink(value, original) || decodeAggregatorLink(original, original);
          if(fallback) return fallback;
        }

        if(resolved && resolved !== original && !isLikelyImageUrl(resolved)) return resolved;
        return '';
      }

      function extractRedirectUrl(doc, originalLink, html){
        if(!doc) return '';
        const tryUrl = value => preferExternalArticleUrl(value, originalLink);
        const refresh = doc.querySelector('meta[http-equiv="refresh" i]');
        if(refresh){
          const content = refresh.getAttribute('content') || '';
          const match = content.match(/url=([^;]+)/i);
          if(match){
            const candidate = tryUrl(match[1].trim().replace(/^['"]|['"]$/g, ''));
            if(candidate) return candidate;
          }
        }
        const canonical = doc.querySelector('link[rel="canonical"]');
        if(canonical){
          const candidate = tryUrl(canonical.getAttribute('href'));
          if(candidate) return candidate;
        }
        const ogUrl = doc.querySelector('meta[property="og:url"], meta[name="og:url"]');
        if(ogUrl){
          const candidate = tryUrl(ogUrl.getAttribute('content'));
          if(candidate) return candidate;
        }
        const alt = doc.querySelector('link[rel="alternate"][href]');
        if(alt){
          const candidate = tryUrl(alt.getAttribute('href'));
          if(candidate) return candidate;
        }
        const anchors = doc.querySelectorAll('a[href]');
        for(const anchor of anchors){
          const candidate = tryUrl(anchor.getAttribute('href'));
          if(candidate) return candidate;
        }
        if(typeof html === 'string' && html){
          const matches = html.match(/https?:\/\/[^"'\s<>]+/g) || [];
          for(const raw of matches){
            const cleaned = raw.replace(/&amp;/g, '&');
            const candidate = tryUrl(cleaned);
            if(candidate) return candidate;
          }
        }
        return '';
      }

      function directImageFromItem(item){
        if(!item || typeof item !== 'object') return '';
        const candidates = [
          item.image, item.imageUrl, item.urlToImage, item.thumbnail, item.thumbnailUrl, item.image_link, item.imageLink, item.picture,
          item.enclosure && (typeof item.enclosure === 'string' ? item.enclosure : item.enclosure.url || item.enclosure.link),
          item.media && (item.media.url || item.media.image),
          item['media:content'] && (item['media:content'].url || item['media:content'].href),
          item['media:thumbnail'] && item['media:thumbnail'].url
        ];
        for(const candidate of candidates){
          if(typeof candidate === 'string' && candidate.trim()) return candidate.trim();
        }
        const htmlSnippets = [item.description, item.summary, item.content, item.contentSnippet, item['content:encoded']];
        for(const snippet of htmlSnippets){
          if(typeof snippet !== 'string' || !snippet.trim()) continue;
          try {
            const parsed = new DOMParser().parseFromString(snippet, 'text/html');
            const docImg = findDocumentImage(parsed);
            if(docImg) return docImg;
            const inlineImg = parsed.querySelector('img');
            if(inlineImg){
              const fromImg = bestFromImageElement(inlineImg);
              if(fromImg) return fromImg;
            }
          } catch {
            /* ignore snippet parse errors */
          }
        }
        return '';
      }

      function ensureThumbFallback(el, text){
        if(!el) return null;
        let fallback = el.querySelector('.news-thumb__fallback');
        if(!fallback){
          fallback = document.createElement('span');
          fallback.className = 'news-thumb__fallback';
          el.appendChild(fallback);
        }
        if(typeof text === 'string') fallback.textContent = text;
        return fallback;
      }

      function displayPreviewImage(el, src, base, onError){
        if(!el) return false;
        const resolved = resolveUrlMaybe(src, base || document.baseURI);
        if(!resolved) return false;
        ensureThumbFallback(el, 'Loading preview…');
        Array.from(el.querySelectorAll('img')).forEach(img => img.remove());
        el.classList.remove('is-empty');
        el.classList.remove('has-image');
        const img = document.createElement('img');
        img.alt = '';
        img.loading = 'lazy';
        img.decoding = 'async';
        img.referrerPolicy = 'no-referrer';
        img.src = resolved;
        el.appendChild(img);
        img.addEventListener('load', () => { el.classList.add('has-image'); }, { once:true });
        img.addEventListener('error', () => {
          img.remove();
          el.classList.remove('has-image');
          el.classList.add('is-empty');
          ensureThumbFallback(el, 'Preview unavailable');
          if(typeof onError === 'function') onError();
        }, { once:true });
        return true;
      }

      function clamp(value, min, max){
        return Math.min(max, Math.max(min, value));
      }

      function hashCode(str){
        let hash = 0;
        const input = (str || '').trim();
        for(let i = 0; i < input.length; i++){
          hash = (hash << 5) - hash + input.charCodeAt(i);
          hash |= 0;
        }
        return Math.abs(hash);
      }

      function wrapTitleLines(title, maxLength, maxLines){
        const words = (title || '').trim().split(/\s+/).filter(Boolean);
        if(words.length === 0) return ['Latest biomedical news'];
        const lines = [];
        let current = '';
        let index = 0;
        while(index < words.length && lines.length < maxLines){
          const word = words[index];
          const candidate = current ? current + ' ' + word : word;
          if(candidate.length <= maxLength || !current){
            current = candidate;
            index += 1;
          } else {
            lines.push(current);
            current = '';
            if(lines.length === maxLines - 1){
              break;
            }
          }
        }
        if(current && lines.length < maxLines){
          lines.push(current);
        }
        if(lines.length < maxLines && index < words.length){
          lines.push(words.slice(index).join(' '));
        }
        return lines.slice(0, maxLines).map(line => line.trim()).filter(Boolean);
      }

      function sanitizeSvgText(str){
        return (str || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
      }

      function generatedPreviewDataUrl(item){
        if(!item) return '';
        const title = (item.title || '(untitled)').trim();
        const source = (item.source || hostFrom(item.link) || 'Angers Lab News').trim();
        const hash = hashCode(title + '|' + source);
        const hue = hash % 360;
        const hue2 = (hue + 38) % 360;
        const sat = clamp(55 + (hash % 18), 45, 70);
        const light = clamp(48 + (hash % 10), 42, 60);
        const gradA = `hsl(${hue}, ${sat}%, ${light + 8}%)`;
        const gradB = `hsl(${hue2}, ${sat + 8}%, ${light - 10}%)`;
        const lines = wrapTitleLines(title, 28, 3).map(sanitizeSvgText);
        const safeSource = sanitizeSvgText(source);
        const svg = `<?xml version="1.0" encoding="UTF-8"?>\n` +
          `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 960 540" role="img" aria-label="${sanitizeSvgText(title)}">` +
            `<defs>` +
              `<linearGradient id="g" x1="0" y1="0" x2="1" y2="1">` +
                `<stop offset="0%" stop-color="${gradA}"/>` +
                `<stop offset="100%" stop-color="${gradB}"/>` +
              `</linearGradient>` +
            `</defs>` +
            `<rect width="960" height="540" rx="60" fill="url(#g)"/>` +
            `<g fill="rgba(255,255,255,0.92)" font-family="'Segoe UI', 'Inter', system-ui" font-weight="600">` +
              `<text x="60" y="120" font-size="32" opacity="0.8">${safeSource}</text>` +
              `<text x="60" y="220" font-size="56" line-height="1.2">` +
                lines.map((line, idx) => `<tspan x="60" dy="${idx === 0 ? 0 : 68}">${line}</tspan>`).join('') +
              `</text>` +
            `</g>` +
          `</svg>`;
        return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
      }

      function showNoPreview(el, text, item){
        if(!el) return;
        Array.from(el.querySelectorAll('img')).forEach(img => img.remove());
        el.classList.remove('has-image');
        el.classList.add('is-empty');
        const generated = generatedPreviewDataUrl(item);
        if(generated){
          const ok = displayPreviewImage(el, generated, document.baseURI, () => ensureThumbFallback(el, text || 'Preview unavailable'));
          if(ok) return;
        }
        ensureThumbFallback(el, text || 'Preview unavailable');
      }

      function findMetaImage(doc){
        if(!doc) return '';
        for(const selector of PREVIEW_META_SELECTORS){
          const node = doc.querySelector(selector);
          if(!node) continue;
          const attr = selector.startsWith('link') ? 'href' : 'content';
          const value = node.getAttribute(attr);
          if(value && value.trim()) return value.trim();
        }
        return '';
      }

      async function discoverPreview(link, visited){
        if(!link) return '';
        const seen = visited || new Set();
        if(seen.has(link)) return '';
        seen.add(link);
        if(isAggregatorUrl(link)){
          const decoded = decodeAggregatorLink(link, link);
          if(decoded && !seen.has(decoded)){
            const redirected = await discoverPreview(decoded, seen);
            if(redirected) return redirected;
          }
        }
        try{
          const res = await proxyFetch(link);
          if(!res.ok) throw new Error('HTTP '+res.status);
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const candidates = [];
          const meta = findMetaImage(doc);
          if(meta){
            const resolved = resolveUrlMaybe(meta, link);
            if(resolved) candidates.push(resolved);
          }
          const jsonLd = findJsonLdImage(doc);
          if(jsonLd){
            const resolved = resolveUrlMaybe(jsonLd, link);
            if(resolved) candidates.push(resolved);
          }
          const docImage = findDocumentImage(doc);
          if(docImage){
            const resolved = resolveUrlMaybe(docImage, link);
            if(resolved) candidates.push(resolved);
          }
          const redirect = extractRedirectUrl(doc, link, html);
          if(redirect && !seen.has(redirect)){
            const redirected = await discoverPreview(redirect, seen);
            if(redirected) return redirected;
          }
          for(const candidate of candidates){ if(candidate) return candidate; }
        }catch(err){ console.warn('Preview image fetch failed', link, err); }
        return '';
      }

      function getPreviewImage(link){
        if(!link) return Promise.resolve('');
        if(PREVIEW_CACHE.has(link)) return PREVIEW_CACHE.get(link);
        const promise = discoverPreview(link, new Set()).then(src => src || '').catch(() => '');
        PREVIEW_CACHE.set(link, promise);
        return promise;
      }

      // Try a local JSON first if you opt to build it via GitHub Actions
      async function tryLocalJSON(){
        try{
          const r = await fetch('assets/data/news.json', {cache:'no-cache'});
          if(!r.ok) return [];
          const arr = await r.json();
          return Array.isArray(arr) ? arr : [];
        }catch{ return []; }
      }

      async function fetchRSS(url){
        // Use r.jina.ai as a CORS-friendly proxy that returns raw feed text
        const res = await proxyFetch(url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const xml = await res.text();
        const doc = new DOMParser().parseFromString(xml, 'text/xml');
        const items = Array.from(doc.querySelectorAll('item'));
        function textContent(node, selector){
          const found = node.querySelector(selector);
          return found?.textContent?.trim() || '';
        }
        function attr(el, name){
          if(!el) return '';
          return (el.getAttribute(name) || '').trim();
        }
        function first(node, selectors){
          for(const selector of selectors){
            const match = node.querySelector(selector);
            if(match) return match;
          }
          return null;
        }
        return items.map(it => {
          const linkText = textContent(it, 'link');
          const link = linkText.trim();
          const host = link ? (() => { try { return new URL(link).host.replace(/^www\./,''); } catch { return ''; } })() : '';
          const description = textContent(it, 'description');
          const summary = textContent(it, 'summary');
          const contentEncoded = textContent(it, 'content\\:encoded');
          const enclosureEl = first(it, ['enclosure[url]', 'enclosure']);
          const mediaContentEl = first(it, ['media\\:content[url]', 'media\\:group media\\:content[url]', 'media\\:content', 'media\\:group media\\:content']);
          const mediaThumbEl = first(it, ['media\\:thumbnail[url]', 'media\\:group media\\:thumbnail[url]', 'media\\:thumbnail', 'media\\:group media\\:thumbnail']);
          const imageNode = first(it, ['image url', 'image']);

          const out = {
            title: textContent(it, 'title'),
            link,
            pubDate: textContent(it, 'pubDate'),
            source: textContent(it, 'source') || host,
            description,
            summary,
            'content:encoded': contentEncoded
          };

          if(enclosureEl){
            const enclosureUrl = attr(enclosureEl, 'url') || attr(enclosureEl, 'href');
            if(enclosureUrl){
              out.enclosure = {
                url: enclosureUrl,
                type: attr(enclosureEl, 'type'),
                length: attr(enclosureEl, 'length')
              };
              if(!out.image && isLikelyImageUrl(enclosureUrl)){
                out.image = enclosureUrl;
              }
            }
          }

          if(mediaContentEl){
            const mediaUrl = attr(mediaContentEl, 'url') || attr(mediaContentEl, 'href');
            if(mediaUrl){
              const mediaObj = {
                url: mediaUrl,
                type: attr(mediaContentEl, 'type'),
                medium: attr(mediaContentEl, 'medium'),
                width: attr(mediaContentEl, 'width'),
                height: attr(mediaContentEl, 'height')
              };
              out['media:content'] = mediaObj;
              if(!out.image && (isLikelyImageUrl(mediaUrl) || /^image\//i.test(mediaObj.type) || /image/i.test(mediaObj.medium))){
                out.image = mediaUrl;
              }
            }
          }

          if(mediaThumbEl){
            const thumbUrl = attr(mediaThumbEl, 'url') || attr(mediaThumbEl, 'href');
            if(thumbUrl){
              const thumbObj = {
                url: thumbUrl,
                width: attr(mediaThumbEl, 'width'),
                height: attr(mediaThumbEl, 'height')
              };
              out['media:thumbnail'] = thumbObj;
              if(!out.thumbnail && isLikelyImageUrl(thumbUrl)){
                out.thumbnail = thumbUrl;
              }
            }
          }

          if(imageNode){
            const inline = textContent(imageNode, 'url') || imageNode.textContent?.trim() || '';
            if(inline) out.image = out.image || inline;
          }

          return out;
        });
      }

      async function tryFeeds(){
        const feeds = [
          // Google News RSS — country/language set to CA/en
          'https://news.google.com/rss/search?q=%22Stephane%20Angers%22%20(biomedical%20OR%20Wnt%20OR%20Toronto%20OR%20Donnelly%20Centre%20OR%20cancer%20OR%20signaling)&hl=en-CA&gl=CA&ceid=CA:en',
          // Yahoo News RSS
          'https://news.search.yahoo.com/rss?p=%22Stephane%20Angers%22%20(biomedical%20OR%20Wnt%20OR%20Toronto%20OR%20cancer%20OR%20signaling)'
        ];
        const out = [];
        for(const f of feeds){
          try { out.push(...(await fetchRSS(f))); }
          catch(e) { console.warn('Feed failed', f, e); }
        }
        return out;
      }

      try {
        statusEl.textContent = 'Loading news…';
        statusEl.title = '';
        let usedLocalJSON = false;
        let items = await tryLocalJSON();
        if(items.length > 0){
          usedLocalJSON = true;
          try {
            const feedItems = await tryFeeds();
            if(Array.isArray(feedItems) && feedItems.length){
              const enriched = mergeItemsWithFeed(items, feedItems);
              const seenKeys = new Set();
              enriched.forEach(it => {
                if(!it || typeof it !== 'object') return;
                const key = (it.link || it.title || '').trim();
                if(key) seenKeys.add(key);
              });
              feedItems.forEach(feedItem => {
                if(!feedItem) return;
                const key = (feedItem.link || feedItem.title || '').trim();
                if(!key || seenKeys.has(key)) return;
                seenKeys.add(key);
                enriched.push(feedItem);
              });
              items = enriched;
            }
          } catch (err) {
            console.warn('Feed enrichment failed', err);
          }
        } else {
          items = await tryFeeds();
        }

        // Deduplicate by link/title and filter to biomedical context
        const seen = new Set();
        items = items.filter(it => {
          if(!it || typeof it !== 'object') return false;
          const key = (it.link || it.title).trim();
          if(!key || seen.has(key)) return false;
          seen.add(key);
          const text = (it.title || '') + ' ' + (it.description || '');
          if(usedLocalJSON){ return true; }
          const hasName = /stephane\s+angers/i.test(text) || /stephane\s+angers/i.test(it.link||'');
          return hasName && includesBioKeywords(text + ' ' + (it.link||''));
        });

        // Sort by date desc (falls back to original order if invalid dates)
        items.sort((a,b)=> (new Date(b.pubDate).getTime() || 0) - (new Date(a.pubDate).getTime() || 0));

        listEl.textContent = '';
        if(items.length === 0){
          statusEl.textContent = 'No recent biomedical news found. Try again later or add items to assets/data/news.json.';
          const p = document.createElement('p');
          p.className = 'empty';
          p.textContent = 'Tip: Schedule a GitHub Action to write assets/data/news.json nightly from Google News/Yahoo queries for fully reliable updates.';
          listEl.appendChild(p);
          return;
        }

        statusEl.textContent = 'Showing ' + items.length + ' result' + (items.length>1?'s':'');
        for(const it of items){
          const art = document.createElement('article');
          art.className = 'news-card';
          const main = document.createElement('div');
          main.className = 'news-main';
          const header = document.createElement('div');
          header.className = 'news-header';

          const h = document.createElement('h3');
          h.className = 'news-title';
          const a = document.createElement('a');
          a.href = it.link || '#';
          a.rel = 'noopener noreferrer';
          a.target = '_blank';
          a.textContent = it.title || '(untitled)';
          h.appendChild(a);

          const meta = document.createElement('div');
          meta.className = 'news-meta';
          const src = it.source || (it.link ? new URL(it.link).host.replace(/^www\./,'') : '');
          meta.textContent = [src, fmtDate(it.pubDate)].filter(Boolean).join(' · ');

          const preview = document.createElement(it.link ? 'a' : 'div');
          preview.className = 'news-thumb';
          if(it.link){
            preview.href = it.link;
            preview.target = '_blank';
            preview.rel = 'noopener noreferrer';
            preview.setAttribute('aria-label', 'Open "' + (it.title || 'article') + '" in new tab');
          }
          ensureThumbFallback(preview, it.link ? 'Loading preview…' : 'Preview unavailable');
          header.appendChild(h);
          header.appendChild(preview);

          main.appendChild(header);
          main.appendChild(meta);

          const action = document.createElement('div');
          action.className = 'news-actions';
          const chip = document.createElement('a');
          chip.className = 'chip';
          chip.href = it.link || '#';
          chip.target = '_blank';
          chip.rel = 'noopener noreferrer';
          chip.textContent = 'Read';
          action.appendChild(chip);
          main.appendChild(action);

          art.appendChild(main);
          listEl.appendChild(art);

          const baseUrl = it.link || document.baseURI;
          const inlineImage = directImageFromItem(it);
          const showInlineFallback = (noLink = false) => {
            if(noLink){ showNoPreview(preview, 'No link available', it); return; }
            if(inlineImage){
              const ok = displayPreviewImage(preview, inlineImage, baseUrl, () => showNoPreview(preview, undefined, it));
              if(!ok){ showNoPreview(preview, undefined, it); }
            } else { showNoPreview(preview, undefined, it); }
          };
          if(it.link){
            ensureThumbFallback(preview, 'Loading preview…');
            getPreviewImage(it.link).then(src => {
              if(src && displayPreviewImage(preview, src, it.link, () => showInlineFallback())) return;
              showInlineFallback();
            });
          } else { showInlineFallback(true); }
        }
      } catch (err){
        statusEl.textContent = 'Failed to load news: ' + err.message;
        statusEl.title = (err && (err.stack || err.message)) || '';
      }
    })();
  </script>
</body>
</html>
