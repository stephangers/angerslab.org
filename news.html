<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>News | Angers Lab</title>
  <meta name="description" content="Latest news featuring Stephane Angers and Angers Lab biomedical research." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230a0a0a'/><text x='50' y='58' font-size='60' text-anchor='middle' fill='%23ffffff' font-family='Arial, Helvetica, sans-serif'>A</text></svg>">
  <style>
    :root { --bg:#0b0c10; --panel:#111317; --elev:#161a20; --text:#e9eef5; --muted:#aeb6c2; --brand:#59d5ff; --brand-2:#7bffb1; --link:var(--brand); --maxw:1100px; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35) }
    @media (prefers-color-scheme: light){ :root{ --bg:#f6f8fb; --panel:#ffffff; --elev:#f1f4f8; --text:#0f172a; --muted:#4b5563; --brand:#005bff; --brand-2:#00ad6b; --link:#0b63ff } }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);
         background:radial-gradient(1200px 600px at 80% -50%, rgba(89,213,255,.15), transparent 60%), radial-gradient(900px 500px at -10% 0%, rgba(123,255,177,.12), transparent 55%), var(--bg);
         line-height:1.55}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:var(--maxw);margin-inline:auto;padding-inline:clamp(16px,3vw,32px)}
    h1{font-size:clamp(28px,4vw,44px);margin:10px 0 8px}
    .lead{color:var(--muted);max-width:72ch}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    .mt-1{margin-top:6px}.mt-2{margin-top:12px}.mt-3{margin-top:18px}.mt-4{margin-top:26px}
    /* Canonical site header + nav (matched to index-2/research-2) */
    header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(140%) blur(8px); background: linear-gradient(180deg, color-mix(in oklab, var(--bg) 30%, transparent), color-mix(in oklab, var(--bg) 55%, transparent)), url('assets/images/banner-wnt.svg') center/cover no-repeat; border-bottom: 2px solid color-mix(in oklab, var(--text) 10%, transparent); }
    .nav { display: flex; align-items: center; justify-content: space-between; height: 80px; }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; letter-spacing: .2px; }
    .brand .logo { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), var(--brand-2)); display: grid; place-items: center; color: #001319; font-weight: 900; box-shadow: var(--shadow); }
    nav ul { list-style: none; margin: 0; padding: 0; display: flex; gap: 22px; align-items: center; }
    nav a { color: var(--text); opacity: .95; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,.25); }
    nav a.active { font-weight: bold; text-decoration: underline; }
    .menu-btn { display: none; background: none; border: none; color: var(--text); font-size: 28px; }
    @media (max-width: 860px) {
      nav ul { display: none; position: absolute; top: 64px; left: 0; right: 0; background: var(--panel); border-bottom: 2px solid color-mix(in oklab, var(--text) 10%, transparent); padding: 12px 18px; flex-direction: column; gap: 8px; }
      .menu-btn { display: inline-block !important; }
      nav ul.open { display: flex !important; }
      body.no-scroll { overflow: hidden; }
    }
    /* News list */
    main{padding:clamp(24px,5vw,48px) 0}
    .news-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:clamp(12px,2vw,20px)}
    .news-card{grid-column:span 12;background:var(--panel);border:1px solid color-mix(in oklab, var(--text) 10%, transparent);border-radius:18px;padding:16px;box-shadow:var(--shadow);display:grid;grid-template-columns:minmax(0,1fr) clamp(180px,25vw,240px);gap:clamp(14px,3vw,22px);align-items:stretch}
    .news-main{display:flex;flex-direction:column;gap:10px;min-width:0}
    .news-aside{display:flex;flex-direction:column;align-items:flex-end;gap:12px}
    .news-thumb{width:100%;aspect-ratio:16/9;display:grid;place-items:center;border-radius:14px;overflow:hidden;background:color-mix(in oklab, var(--text) 6%, transparent);box-shadow:inset 0 0 0 1px color-mix(in oklab, var(--text) 8%, transparent);color:var(--muted);text-align:center;font-size:.85rem;padding:8px;position:relative;text-decoration:none;font-weight:600}
    .news-thumb:hover{text-decoration:none}
    .news-thumb img{grid-area:1/1;width:100%;height:100%;object-fit:cover}
    .news-thumb__fallback{grid-area:1/1;padding:0 6px}
    .news-thumb.has-image{color:transparent;background:color-mix(in oklab, var(--text) 4%, transparent)}
    .news-thumb.has-image .news-thumb__fallback{display:none}
    .news-thumb.is-empty{color:var(--muted)}
    .news-aside .news-actions{justify-content:flex-end;width:100%}
    @media (max-width:900px){ .news-card{grid-template-columns:minmax(0,1fr) clamp(160px,32vw,220px);} }
    @media (max-width:720px){ .news-card{grid-template-columns:1fr} .news-aside{flex-direction:row;align-items:center;justify-content:space-between} .news-thumb{width:clamp(140px,42vw,220px)} .news-aside .news-actions{justify-content:flex-end} }
    @media (max-width:560px){ .news-aside{flex-direction:column;align-items:flex-start;gap:10px} .news-thumb{width:100%} .news-aside .news-actions{width:100%;justify-content:flex-start} }
    .news-card h3{margin:0 0 4px;font-size:18px}
    .news-meta{color:var(--muted);font-size:.95rem}
    .news-actions{display:flex;gap:10px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:color-mix(in oklab, var(--text) 8%, transparent);color:var(--text);font-weight:600}
    .empty{color:var(--muted);padding:14px 0}
    footer{border-top:1px solid color-mix(in oklab, var(--text) 10%, transparent);padding:18px 0 32px;color:var(--muted)}
    .footer-grid{display:grid;grid-template-columns:2fr 1fr 1fr;gap:24px}
    .footer-grid a{color:var(--muted)}
    @media (max-width:820px){ .footer-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <a class="sr-only" href="#main">Skip to content</a>
  <header>
    <div class="wrap nav">
      <a aria-label="Angers Lab Home" class="brand" href="index.html">
        <span class="logo">A</span>
        <span>Angers Lab<br/><small>Cellular Signaling &amp; Regeneration</small></span>
      </a>
      <nav>
        <button class="menu-btn" aria-label="Open menu" onclick="toggleMenu()" aria-expanded="false">☰</button>
        <ul id="menu">
          <li><a href="index.html">Home</a></li>
          <li><a href="stephane-angers.html">Stephane Angers</a></li>
          <li><a href="research.html">Research</a></li>
          <li><a href="people.html">People</a></li>
          <li><a href="publications.html">Publications</a></li>
          <li><a href="news.html" class="active"><span class="active"></span>News</a></li>
          <li><a href="#contact">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main id="main">
    <section class="wrap page-head">
      <span class="chip">Live from the web</span>
      <h1>News</h1>
      <p class="lead">Automatically curated mentions of <b>Stephane Angers</b> in biomedical science contexts. Each item shows the source and date.</p>
    </section>

    <section class="wrap" id="news-section">
      <div id="status" class="news-meta"></div>
      <div id="news" class="news-grid" aria-live="polite"></div>
    </section>
  </main>

  <footer>
    <div class="wrap footer-grid">
      <div>
        <b>Angers Lab</b>
        <p class="mt-1">Cellular Signaling &amp; Regeneration · Donnelly Centre · University of Toronto</p>
      </div>
      <div>
        <b>Navigate</b>
        <nav class="mt-1">
          <a href="stephane-angers.html">Stephane Angers</a><br>
          <a href="research.html">Research</a><br>
          <a href="people.html">People</a><br>
          <a href="publications.html">Publications</a><br>
          <a href="news.html" class="active"><span class="active"></span>News</a>
        </nav>
      </div>
      <div>
        <b>Social</b>
        <p class="mt-1"><a href="#" aria-label="LinkedIn">LinkedIn</a> · <a href="#" aria-label="Google Scholar">Google Scholar</a> · <a href="#" aria-label="ORCID">ORCID</a></p>
        <p class="mt-1">© <span id="year"></span> Angers Lab. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // Header menu toggle (matches index-2/research-2)
    (function () {
      const btn  = document.querySelector('.menu-btn');
      const menu = document.getElementById('menu');
      if (!btn || !menu) return;
      function set(open) {
        menu.classList.toggle('open', open);
        btn.setAttribute('aria-expanded', String(open));
        document.body.classList.toggle('no-scroll', open);
      }
      window.toggleMenu = () => set(!menu.classList.contains('open'));
      menu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => set(false)));
      window.addEventListener('resize', () => { if (window.innerWidth > 860) set(false); });
    })();
    document.getElementById('year').textContent = new Date().getFullYear();

    // --- News aggregation ---
    (async function loadNews(){
      const statusEl = document.getElementById('status');
      const listEl = document.getElementById('news');

      const KEYWORDS = [
        'wnt','frizzled','β-catenin','beta-catenin','cancer','regeneration','glioblastoma','signaling','donnelly','university of toronto','fgf','surrogate','agonist','endothelial','barrier'
      ];

      const PREVIEW_CACHE = new Map();
      const PREVIEW_META_SELECTORS = [
        'meta[property="og:image:secure_url"]',
        'meta[property="og:image:url"]',
        'meta[property="og:image"]',
        'meta[name="og:image"]',
        'meta[property="twitter:image:src"]',
        'meta[name="twitter:image:src"]',
        'meta[property="twitter:image"]',
        'meta[name="twitter:image"]',
        'meta[property="article:image"]',
        'meta[name="image"]',
        'meta[name="thumbnail"]',
        'meta[property="thumbnail"]',
        'link[rel="image_src"]'
      ];

      function toProxyURL(url){
        if(!url) return '';
        const clean = String(url).replace(/^https?:\/\//,'');
        return 'https://r.jina.ai/http://' + clean.replace(/&/g,'&');
      }
      function proxyFetch(url, init){
        const proxied = toProxyURL(url);
        if(!proxied) return Promise.reject(new Error('Invalid URL'));
        const opts = Object.assign({ cache:'no-cache' }, init || {});
        return fetch(proxied, opts);
      }

      function hostFrom(url){
        try { return new URL(url).host.replace(/^www\\./,''); } catch { return ''; }
      }
      function fmtDate(dstr){
        const d = new Date(dstr || '');
        if(!(d instanceof Date) || isNaN(d.getTime())) return dstr || '';
        return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'});
      }
      function includesBioKeywords(text){
        const t = (text||'').toLowerCase();
        return KEYWORDS.some(k => t.includes(k));
      }
      function normalizeNewsJson(obj){
        if (Array.isArray(obj)) return obj;
        if (obj && Array.isArray(obj.items)) return obj.items;
        if (obj && Array.isArray(obj.data)) return obj.data;
        if (obj && Array.isArray(obj.articles)) return obj.articles;
        if (obj && typeof obj === 'object') {
          const vals = Object.values(obj).filter(v => v && typeof v === 'object');
          const maybe = vals.filter(v => ('title' in v) || ('link' in v));
          if (maybe.length) return maybe;
        }
        return [];
      }

      function resolveUrlMaybe(value, base){
        if(!value) return '';
        try {
          return new URL(value, base || undefined).href;
        } catch {
          return '';
        }
      }
      function directImageFromItem(item){
        if(!item || typeof item !== 'object') return '';
        const candidates = [
          item.image,
          item.imageUrl,
          item.urlToImage,
          item.thumbnail,
          item.thumbnailUrl,
          item.image_link,
          item.imageLink,
          item.picture,
          item.enclosure && (typeof item.enclosure === 'string' ? item.enclosure : item.enclosure.url || item.enclosure.link),
          item.media && (item.media.url || item.media.image),
          item['media:content'] && (item['media:content'].url || item['media:content'].href),
          item['media:thumbnail'] && item['media:thumbnail'].url
        ];
        for(const candidate of candidates){
          if(typeof candidate === 'string' && candidate.trim()) return candidate.trim();
        }
        return '';
      }
      function ensureThumbFallback(el, text){
        if(!el) return null;
        let fallback = el.querySelector('.news-thumb__fallback');
        if(!fallback){
          fallback = document.createElement('span');
          fallback.className = 'news-thumb__fallback';
          el.appendChild(fallback);
        }
        if(typeof text === 'string') fallback.textContent = text;
        return fallback;
      }
      function displayPreviewImage(el, src, base, onError){
        if(!el) return false;
        const resolved = resolveUrlMaybe(src, base || document.baseURI);
        if(!resolved) return false;
        ensureThumbFallback(el, 'Loading preview…');
        Array.from(el.querySelectorAll('img')).forEach(img => img.remove());
        el.classList.remove('is-empty');
        el.classList.remove('has-image');
        const img = document.createElement('img');
        img.alt = '';
        img.loading = 'lazy';
        img.decoding = 'async';
        img.src = resolved;
        el.appendChild(img);
        img.addEventListener('load', () => {
          el.classList.add('has-image');
        }, { once:true });
        img.addEventListener('error', () => {
          img.remove();
          el.classList.remove('has-image');
          el.classList.add('is-empty');
          ensureThumbFallback(el, 'Preview unavailable');
          if(typeof onError === 'function') onError();
        }, { once:true });
        return true;
      }
      function showNoPreview(el, text){
        if(!el) return;
        Array.from(el.querySelectorAll('img')).forEach(img => img.remove());
        el.classList.remove('has-image');
        el.classList.add('is-empty');
        ensureThumbFallback(el, text || 'Preview unavailable');
      }
      function findMetaImage(doc){
        if(!doc) return '';
        for(const selector of PREVIEW_META_SELECTORS){
          const node = doc.querySelector(selector);
          if(!node) continue;
          const attr = selector.startsWith('link') ? 'href' : 'content';
          const value = node.getAttribute(attr);
          if(value && value.trim()) return value.trim();
        }
        return '';
      }
      async function discoverPreview(link){
        if(!link) return '';
        try{
          const res = await proxyFetch(link);
          if(!res.ok) throw new Error('HTTP '+res.status);
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const meta = findMetaImage(doc);
          if(meta) return resolveUrlMaybe(meta, link);
          const imgEl = doc.querySelector('article img[src], main img[src], figure img[src], img[src]');
          if(imgEl){
            const val = imgEl.getAttribute('src') || imgEl.getAttribute('data-src');
            if(val && val.trim()) return resolveUrlMaybe(val.trim(), link);
          }
        }catch(err){
          console.warn('Preview image fetch failed', link, err);
        }
        return '';
      }
      function getPreviewImage(link){
        if(!link) return Promise.resolve('');
        if(PREVIEW_CACHE.has(link)) return PREVIEW_CACHE.get(link);
        const promise = discoverPreview(link).then(src => src || '').catch(() => '');
        PREVIEW_CACHE.set(link, promise);
        return promise;
      }

      // Try a local JSON first if you opt to build it via GitHub Actions
      async function tryLocalJSON(){
        try{
          const r = await fetch('assets/data/news.json', {cache:'no-cache'});
          if(!r.ok) return [];
          const arr = await r.json();
          return Array.isArray(arr) ? arr : [];
        }catch{ return []; }
      }

      async function fetchRSS(url){
        // Use r.jina.ai as a CORS-friendly proxy that returns raw feed text
        const res = await proxyFetch(url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const xml = await res.text();
        const doc = new DOMParser().parseFromString(xml, 'text/xml');
        const items = Array.from(doc.querySelectorAll('item'));
        return items.map(it => ({
          title: it.querySelector('title')?.textContent?.trim() || '',
          link: it.querySelector('link')?.textContent?.trim() || '',
          pubDate: it.querySelector('pubDate')?.textContent?.trim() || '',
          source: (it.querySelector('source')?.textContent?.trim() || hostFrom(it.querySelector('link')?.textContent || ''))
        }));
      }

      async function tryFeeds(){
        const feeds = [
          // Google News RSS — country/language set to CA/en
          'https://news.google.com/rss/search?q=%22Stephane%20Angers%22%20(biomedical%20OR%20Wnt%20OR%20Toronto%20OR%20Donnelly%20Centre%20OR%20cancer%20OR%20signaling)&hl=en-CA&gl=CA&ceid=CA:en',
          // Yahoo News RSS
          'https://news.search.yahoo.com/rss?p=%22Stephane%20Angers%22%20(biomedical%20OR%20Wnt%20OR%20Toronto%20OR%20cancer%20OR%20signaling)'
        ];
        const out = [];
        for(const f of feeds){
          try {
            const items = await fetchRSS(f);
            out.push(...items);
          } catch(e) {
            console.warn('Feed failed', f, e);
          }
        }
        return out;
      }

      try {
        statusEl.textContent = 'Loading news…';
        statusEl.title = '';
        let usedLocalJSON = false;
        let items = await tryLocalJSON();
        if(items.length > 0){
          usedLocalJSON = true;
        } else {
          items = await tryFeeds();
        }

        // Deduplicate by link/title and filter to biomedical context
        const seen = new Set();
        items = items.filter(it => {
          const key = (it.link || it.title).trim();
          if(!key || seen.has(key)) return false;
          seen.add(key);
          const text = (it.title || '') + ' ' + (it.description || '');
          if(usedLocalJSON){
            return true;
          }
          // Must mention Stephane Angers and have biomedical hint
          const hasName = /stephane\s+angers/i.test(text) || /stephane\s+angers/i.test(it.link||'');
          return hasName && includesBioKeywords(text + ' ' + it.link);
        });

        // Sort by date desc
        items.sort((a,b)=> new Date(b.pubDate) - new Date(a.pubDate));

        listEl.textContent = '';
        if(items.length === 0){
          statusEl.textContent = 'No recent biomedical news found. Try again later or add items to assets/data/news.json.';
          const p = document.createElement('p');
          p.className = 'empty';
          p.textContent = 'Tip: You can schedule a GitHub Action to write assets/data/news.json nightly from Google News/Yahoo queries for fully reliable updates.';
          listEl.appendChild(p);
          return;
        }

        statusEl.textContent = 'Showing ' + items.length + ' result' + (items.length>1?'s':'');
        for(const it of items){
          const art = document.createElement('article');
          art.className = 'news-card';
          const main = document.createElement('div');
          main.className = 'news-main';
          const aside = document.createElement('div');
          aside.className = 'news-aside';

          const h = document.createElement('h3');
          const a = document.createElement('a');
          a.href = it.link || '#';
          a.rel = 'noopener noreferrer';
          a.target = '_blank';
          a.textContent = it.title || '(untitled)';
          h.appendChild(a);

          const meta = document.createElement('div');
          meta.className = 'news-meta';
          const src = it.source || hostFrom(it.link);
          meta.textContent = [src, fmtDate(it.pubDate)].filter(Boolean).join(' · ');

          main.appendChild(h);
          main.appendChild(meta);

          const preview = document.createElement(it.link ? 'a' : 'div');
          preview.className = 'news-thumb';
          if(it.link){
            preview.href = it.link;
            preview.target = '_blank';
            preview.rel = 'noopener noreferrer';
            preview.setAttribute('aria-label', 'Open "' + (it.title || 'article') + '" in new tab');
          }
          ensureThumbFallback(preview, it.link ? 'Loading preview…' : 'Preview unavailable');
          aside.appendChild(preview);

          const action = document.createElement('div');
          action.className = 'news-actions';
          const chip = document.createElement('a');
          chip.className = 'chip';
          chip.href = it.link || '#';
          chip.target = '_blank';
          chip.rel = 'noopener noreferrer';
          chip.textContent = 'Read';
          action.appendChild(chip);
          aside.appendChild(action);

          art.appendChild(main);
          art.appendChild(aside);
          listEl.appendChild(art);

          const baseUrl = it.link || document.baseURI;
          const inlineImage = directImageFromItem(it);
          const loadFromArticle = () => {
            if(!it.link){
              showNoPreview(preview, 'No link available');
              return;
            }
            ensureThumbFallback(preview, 'Loading preview…');
            getPreviewImage(it.link).then(src => {
              if(src && displayPreviewImage(preview, src, baseUrl)) return;
              showNoPreview(preview);
            });
          };
          if(inlineImage){
            const success = displayPreviewImage(preview, inlineImage, baseUrl, loadFromArticle);
            if(!success){
              loadFromArticle();
            }
          } else {
            loadFromArticle();
          }
        }
      } catch (err){
        statusEl.textContent = 'Failed to load news: ' + err.message;
        statusEl.title = (err && (err.stack || err.message)) || '';
      }
    })();
  </script>
</body>
</html>
